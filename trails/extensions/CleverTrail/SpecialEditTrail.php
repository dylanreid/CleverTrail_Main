<?php//Copyright 2011, Dylan Reid and Clevertrail.cominclude_once("../include/CleverTrailArticle.php");//the class that creates the special page that will allow a user to edit a trailclass SpecialEditTrail extends SpecialPage {	function __construct() {			parent::__construct( 'EditTrail' , '', false, false, 'default', false);			wfLoadExtensionMessages('CleverTrail');	}		function execute( $par ) {		global $wgRequest, $wgOut, $wgScript, $wgReadOnly;				if ($wgReadOnly) {			$wgOut->setPagetitle("CleverTrail is currently read-only: $wgReadOnly");			return;		}				//get the article we're creating/editing		$trailTitle = Title::newFromText($par);											//not really possible unless just calling this page with no argument		//let's redirect to the home page		if (!$trailTitle)		{			header("Location: $wgScript");		}				$this->setHeaders();			$nTrailId = $trailTitle->getArticleId(); 		$bNewTrail = ($nTrailId == 0);				//does the article exist or is this new?		if ($bNewTrail)		{			$trailArticle = new Article($trailTitle);			$wgOut->setPagetitle("Creating $trailTitle");		}		else		{											$trailArticle = Article::newFromId($nTrailId);						$wgOut->setPagetitle("Editing $trailTitle");		}								//was a specific section sent in, otherwise default to the map		$nSection = $wgRequest->getVal('section');		if (!$nSection)			$nSection = 9;							$status = NULL;						//are we saving data or about to edit?		if ($wgRequest->wasPosted()) {					$submitValue = $wgRequest->getVal('submitValue');						if ($submitValue == 'SaveGoTo' || $submitValue == 'SaveContinue') {				$cta = $this->createCleverTrailArticleFromPost();								//just for debugging, it won't get seen if we redirect during normal post handling				//$cta->printInfo();								//save the new article text				if ($bNewTrail) {					$status = $this->saveArticleText($trailArticle, $cta, EDIT_NEW);									} else {					$status = $this->saveArticleText($trailArticle, $cta, EDIT_UPDATE);				}												//if this is a continue, update some values				if ($submitValue == 'SaveContinue')	{					$nSection = $wgRequest->getVal('txtEditTrailSectionNumber');						//if this was a new article, update that					if ($bNewTrail) {						$bNewTrail = false;						$nTrailId = $trailTitle->getArticleId(); 						$trailArticle = Article::newFromId($nTrailId);									$wgOut->setPagetitle("Editing $trailTitle");					}				}			}						$errorStatus = ($status && !$status->isOK());						//This is a bug in the Maps Extension: need to purge this page after update to get the map to work						//$purge_url = $trailTitle->getFullUrl('action=purge');			//$ctx = stream_context_create(array('http' => array('method' => 'POST')));			//$result = @fopen($purge_url, 'rb', false, $ctx);			//END: workaround for maps extension						//redirect if goto article or cancel			if (($submitValue == 'SaveGoTo' && (!$errorStatus)) || $submitValue == 'Cancel') {				$sRedirectURL = $trailTitle->getFullURL();				header("Location: $sRedirectURL");			}					//if not redirecting (i.e. save and continue), refresh the trail article			$trailArticle = Article::newFromId($nTrailId);							}			$cta = new CleverTrailArticle();		if (!$bNewTrail) {			$text = $trailArticle->getRawText();			$cta = CleverTrailArticle::createCleverTrailArticleFromText($text);			$cta->sTitle = $trailArticle->getTitle();		}				//draw all the controls and html for the user to edit the trail		$this->displayEditTrail($cta, $nSection, $status);					}		//do the actual save of the article	function saveArticleText($trailArticle, $cta, $updateOrNewFlag)	{		global $wgOut;		$status = NULL;		if ($cta->sArticleType == "Redirect" && $cta->sRedirect != ''){$text = "#REDIRECT [[" . $cta->sRedirect . "]]";				}		else{		$text = "{{QuickFacts Trail | ImageName= " . $cta->getMainImageWikitext() . "| ImageCredit=" . $cta->getMainImageCreditWikitext() . "| DifficultyRating= " . $cta->getDifficultyWikitext() . "| Distance= " . $cta->getDistanceWikitext() . "| TimeRequired= " . $cta->getTimeRequiredWikitext() . "| TrailUse= " . $cta->getTrailUseWikitext() . "| TrailType=  " . $cta->getTrailTypeWikitext() . "| ElevationGain= " . $cta->getElevationGainWikitext() . "| HighPoint= " . $cta->getHighPointWikitext() . "| LowPoint=  " . $cta->getLowPointWikitext() . "| BestMonths= " . $cta->getBestMonthWikitext() . "| NearestCity= " . $cta->sNearestCity . "}} ";if ($cta->bDisambiguationNote && $cta->sDisambiguationBase != ''){$text .= "{{DisambiguationNote | BaseName=" . $cta->sDisambiguationBase . "}}";}$text .= "<div style=\"float: left; margin: 0 2em 1em 0;\"> __TOC__ </div>== Overview == ";$text .= ($cta->sOverview == "") ? $cta->getEmptySectionText() : $cta->sOverview;$text .= "<!--END:OVERVIEW-->== Directions To Trailhead == ";$text .= ($cta->sDirections == "") ? $cta->getEmptySectionText() : $cta->sDirections;$text .= "<!--END:DIRECTIONS-->== Trail Description == ";$text .= ($cta->sDescription == "") ? $cta->getEmptySectionText() : $cta->sDescription;$text .= "<!--END:DESCRIPTION-->== Conditions And Hazards == ";$text .= ($cta->sConditions == "") ? $cta->getEmptySectionText() : $cta->sConditions;$text .= "<!--END:CONDITIONS-->== Fees, Permits, And Restrictions == ";$text .= ($cta->sFees == "") ? $cta->getEmptySectionText() : $cta->sFees;$text .= "<!--END:FEES--> == Amenities == ";$text .= ($cta->sAmenities == "") ? $cta->getEmptySectionText() : $cta->sAmenities;$text .= "<!--END:AMENITIES-->== Miscellaneous == ";$text .= ($cta->sMisc == "") ? $cta->getEmptySectionText() : $cta->sMisc;$text .= "<!--END:MISCELLANEOUS-->== Photo Gallery == ";if (sizeof($cta->arPhotos) == 0) 	$text .= $cta->getEmptySectionText();$text .= "<gallery>  " ;for ($i=0; $i < sizeof($cta->arPhotos); $i++) {$text .= "Image:" . $cta->arPhotos[$i] . "";}$text .= " </gallery>  == Map ==" . $cta->getGoogleMapWikitext() . "";for ($i=0; $i < sizeof($cta->arCategories); $i++) {$text .= "[[Category:" . $cta->arCategories[$i] . "]]";}$text .= "== Comments And Review =={{#w4grb_rate:}}{{#clevertrail_addthis:}}<discussion> show_all_order=1preview=0quoting=0</discussion><!-->";}	$status = $trailArticle->doEdit($text, "", $updateOrNewFlag);		return $status;	}			//create the html controls for editing a trail	function displayEditTrail($cta, $nSection, $status)	{		global $wgOut, $wgServer, $wgScript, $wgRightsText;		$output = '';				//reference all the javascript/css files we will use		$output .= '<script type="text/javascript" src="' . $wgServer . '/javascript/md5.js" language="javascript"></script>';		$output .= '<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>';					$output .= '<script type="text/javascript" src="' . $wgServer . '/javascript/edittrail.js" language="javascript"></script>';		$output .= '<link type="text/css" href="' . $wgServer . '/css/edittrail.css" rel="stylesheet" media="screen" />';				//no javascript warning		$output .= '	<noscript> 		<div id="divNoJavascriptWarning" style="position:absolute; width: 100%; height:100%; z-index:9999; background: #fff; color: #000;">			<br><br>			CleverTrail.com is designed for browsers with javascript enabled.<br><br>			Please consider turning your javascript on and then trying CleverTrail again.<br><br>			Thanks!<br><br>			<a href="http://clevertrail.com">CleverTrail.com</a>					</div>		</noscript>';				//if there was an error, display it		if ($status && !$status->isOK()) {			$errorHtml = str_replace("\n", "<BR>", $status->getWikitext());			$errorHtml = "There was an error saving the page: <br><br>" . $errorHtml;			$output .= '<script type="text/javascript"> window.onload = new function() {drawCleverTrailAlert("' . $errorHtml . '");};</script>';		}										//form		$output .= '<form id="frmEditTrailForm" name="frmEditTrailForm" action="" method="post">';				$output .= '<input id="txtEditTrailSectionNumber" name="txtEditTrailSectionNumber" style="display:none" value="' . $nSection . '">';				//top save and cancel buttons		$output .= '<table border=0 cellpadding=0 width=100%><tr><td align=left>';		$output .= '<input id="submitValue" name="submitValue" type="text" style="display:none" value="">';		$output .= '<input onclick="submitEditTrailForm(\'SaveGoTo\');" type="button" class="clsSubmitButton"			value="Save & Go To Trail" id="btnEditTrailSaveGoToTrail" name="btnEditTrailSaveGoToTrail" title="Save your changes and go to the trail"> ';		$output .= '<input onclick="submitEditTrailForm(\'SaveContinue\');" type="button"  class="clsSubmitButton"			value="Save & Continue Editing" id="btnEditTrailSaveContinue" name="btnEditTrailSaveContinue" title="Save your changes and continue editing"> ';		$output .= '<input onclick="submitEditTrailForm(\'Cancel\');" type="button"  class="clsSubmitButton"			value="Cancel" id="btnEditTrailCancel" name="btnEditTrailCancel" title="Cancel your changes and return to the trail"> ';				//unsaved changes notice		$output .= '<span id="divEditTrailNotice"></span>';		$output .= '</td><td align=right valign=top width=230>';				//article type		$output .= '<div id="divArticleOptions">';		$output .= 'Article Type ';		$output .= ' <a href="../CleverTrail:Editing_Trails#Article_Types" target="_blank">[?]</a>';		$output .= ': ';		$output .= '<select onchange="changeNoticeUnsavedChanges(); changeArticleType();" id="selEditTrailArticleType" name="selEditTrailArticleType">';		$output .= '<option value="Trail" ';		if ($cta->sArticleType == "Trail") $output .= "selected";		$output .= ' >Trail</option>';		$output .= '<option value="Redirect" ';		if ($cta->sArticleType == "Redirect") $output .= "selected";		$output .= ' >Redirect</option>';		$output .= '</select>';						//disambiguation note				$output .= '<br><span id="spnEditTrailDisambiguationNote" style="display: ';		if ($cta->sArticleType == "Trail") $output .= 'block'; else $output .= 'none';		$output .= '">';		$output .= '<input type="checkbox" name="chkEditTrailAddDisambiguation" id="chkEditTrailAddDisambiguation" ';		if ($cta->bDisambiguationNote)			$output .= ' checked ';				$output .= ' onchange="changeNoticeUnsavedChanges();" > Add disambiguation note to trail';		$output .= ' <a href="../CleverTrail:Editing_Trails#Disambiguation_Pages" target="_blank">[?]</a>';		$output .= '</span>';				//disambiguation base name		$output .= '<div id="divDisambiguationBase" style="display: ';		if ($cta->bDisambiguationNote)			$output .= ' block ';		else			$output .= ' none ';		$output .= '">';		$output .= 'Name to disambiguate:';				$output .= ' <input id="txtDisambiguationBase" name="txtDisambiguationBase" 					type="text" value="' . $cta->sDisambiguationBase . '" onchange="changeNoticeUnsavedChanges(); ">';				$output	.= '</div>';				$output .= '</div></td></tr></table>';				//trail article type		$output .= '<div id="divEditTrailTrail" style="display: ';		if ($cta->sArticleType == "Trail")			$output .= "block";		else			$output .= "none";		$output .= '">';				//BEGIN NAV TABLE				$output .= '<table border=0 width=100% cellpadding=0>';		$output .= '<tr><td	valign=top>';				//Section links		$output .= '<div id="divEditTrailSectionLink">';		$output .= '<div class="clsEditTrailSectionLinkButton';		if ($nSection == 9) $output .= 'Selected';		$output .= '" id="btnEditTrailSectionLinkMap" title="Edit the Map">Map</div><br>';						$output .= '<div class="clsEditTrailSectionLinkButton';		if ($nSection == -1) $output .= 'Selected';		$output .= '" id="btnEditTrailSectionLinkQuickFacts" title="Edit the Quick Facts">Quick Facts</div><br>';						$output .= '<div class="clsEditTrailSectionLinkButton';		if ($nSection == 1) $output .= 'Selected';		$output .= '" id="btnEditTrailSectionLinkOverview" title="Edit the Overview section">Overview</div><br>';				$output .= '<div class="clsEditTrailSectionLinkButton';		if ($nSection == 2) $output .= 'Selected';		$output .= '" id="btnEditTrailSectionLinkDirections" title="Edit the Directs To Trailhead section">Directions To Trailhead</div><br>';				$output .= '<div class="clsEditTrailSectionLinkButton';		if ($nSection == 3) $output .= 'Selected';		$output .= '" id="btnEditTrailSectionLinkDescription" title="Edit the Trail Description section">Trail Description</div><br>';				$output .= '<div class="clsEditTrailSectionLinkButton';		if ($nSection == 4) $output .= 'Selected';		$output .= '" id="btnEditTrailSectionLinkConditions" title="Edit the Conditions & Hazards section">Conditions & Hazards</div><br>';				$output .= '<div class="clsEditTrailSectionLinkButton';		if ($nSection == 5) $output .= 'Selected';		$output .= '" id="btnEditTrailSectionLinkFees" title="Edit the Fees, Permits, & Restrictions section">Fees, Permits, & Restrictions</div><br>';				$output .= '<div class="clsEditTrailSectionLinkButton';		if ($nSection == 6) $output .= 'Selected';		$output .= '" id="btnEditTrailSectionLinkAmenities" title="Edit the Amenities section">Amenities</div><br>';				$output .= '<div class="clsEditTrailSectionLinkButton';		if ($nSection == 7) $output .= 'Selected';		$output .= '" id="btnEditTrailSectionLinkMisc" title="Edit the Miscellaneous section">Miscellaneous</div><br>';				$output .= '<div class="clsEditTrailSectionLinkButton';		if ($nSection == 8) $output .= 'Selected';		$output .= '" id="btnEditTrailSectionLinkPhotoGallery" title="Edit the Photo Gallery">Photo Gallery</div><br>';				$output .= '<div class="clsEditTrailSectionLinkButton';		if ($nSection == -3) $output .= 'Selected';		$output .= '" id="btnEditTrailSectionLinkCategories" title="Edit the Categories">Categories</div>';		$output .= '</div>';				$output .= '</td>';		$output .= '<td valign=top align=center style="padding-left: 10px; padding-right: 10px;">';				//DIV Begin: Quick Facts		$output .= '<div class="clsEditTrailSectionContent" id="divEditTrailSectionQuickFacts" style="display: ';		$output .= ($nSection == -1) ? 'block' : 'none';		$output .= '">';				$output .= '<div id="divQuickFactsTrail">';		$output .= '<table>';				$quickfactsLink = '<a style="text-decoration:underline;" href="../CleverTrail:Editing_Trails#Quick_Facts" target="_blank">[?]</a>';				//main image		$output .= '<tr><th width=150>Main Photo ' . $quickfactsLink . ': </th>			<td width=320><img id="imgEditTrailQuickFactsImage" src="' .$wgServer . '/images/Loadingphoto.jpg" width=300 border=1><br>			<input type="hidden" id="txtEditTrailQuickFactsImageValid" name="txtEditTrailQuickFactsImageValid" value="1">			<input type="text" style="width: 180px" id="txtEditTrailQuickFactsImage" name="txtEditTrailQuickFactsImage" 			 onchange="changeNoticeUnsavedChanges(); loadMainImage();" value="' . $cta->sImage . '"> ';		$uploadFilesLink = $wgScript . '/' . 'Special:Upload';		$output .= '<a style="color: #fff; text-decoration:underline;" href="' . $uploadFilesLink . '" target="_blank">upload photo first</a></td>';		$output .= '</tr>';					//this line must go after everything has been initialized for the main image		$output .= '<script type="text/javascript"> window.onload = new function() {loadMainImage();}; </script>';				//image credit		$output .= '<tr><th>Photo Credit ' . $quickfactsLink . ': </th>			<td><input type="text" onchange="changeNoticeUnsavedChanges();" style="width: 180px;"			id="imgEditTrailQuickFactsImageCredit" name="imgEditTrailQuickFactsImageCredit" 			value="' . $cta->sImageCredit . '"> ';		$output .= '</td></tr>';				//difficulty		$output .= '<tr><th>Difficulty ' . $quickfactsLink . ': </th><td>		<select onchange="changeNoticeUnsavedChanges();" style="width: 185px" class="input" id="selEditTrailQuickFactsDifficulty" name="selEditTrailQuickFactsDifficulty">';		$output .= CleverTrailArticle::drawTrailDifficultyOptions($cta->nDifficulty);		$output .= '</select></td></tr>';					//distance		$output .= '<tr><th>Distance ' . $quickfactsLink . ': </th>			<td><input onchange="changeNoticeUnsavedChanges();" type="text" style="width: 86px"			id="txtEditTrailQuickFactsDistance" name="txtEditTrailQuickFactsDistance" 			value="' . $cta->dDistanceValue . '"> ';		$output .= '<select id="selEditTrailQuickFactsDistance" name="selEditTrailQuickFactsDistance" onchange="changeNoticeUnsavedChanges();">';		$output .= CleverTrailArticle::drawUnitsOptions('miles', $cta->sDistanceUnits);		$output .= '</select>';		$output .= '</td></tr>';				//time required		$output .= '<tr><th>Time Required ' . $quickfactsLink . ': </th>			<td><input onchange="changeNoticeUnsavedChanges();" type="text" style="width: 41px"			id="txtEditTrailQuickFactsTimeRequiredMin" name="txtEditTrailQuickFactsTimeRequiredMin" 			value="' . (($cta->dTimeRequiredMinValue > 0) ? $cta->dTimeRequiredMinValue : '') . '"> - ';		$output .= '<input onchange="changeNoticeUnsavedChanges();" type="text" style="width: 41px"			id="txtEditTrailQuickFactsTimeRequiredMax" name="txtEditTrailQuickFactsTimeRequiredMax" 			value="' . (($cta->dTimeRequiredMaxValue > 0) ? $cta->dTimeRequiredMaxValue : '') . '"> ';		$output .= '<select id="selEditTrailQuickFactsTimeRequired" name="selEditTrailQuickFactsTimeRequired" onchange="changeNoticeUnsavedChanges();">';		$output .= CleverTrailArticle::drawUnitsOptions('time', $cta->sTimeRequiredUnits);		$output .= '</select>';		$output .= '</td></tr>';			//trail type		$output .= '<tr><th>Trail Type ' . $quickfactsLink . ': </th>		<td><select onchange="changeNoticeUnsavedChanges();" style="width: 185px" 			id="selEditTrailQuickFactsTrailType" name="selEditTrailQuickFactsTrailType">';		$output .= CleverTrailArticle::drawTrailTypeOptions($cta->nTrailType);		$output .= '</select></td></tr>';							//trail uses		$output .= '<tr><th>Trail Use ' . $quickfactsLink . ': </th><td>';		$arTrailUse = CleverTrailArticle::getTrailUseArray();		$nItems = 0;		foreach ($arTrailUse as $use) {							$output .= '<input onchange="changeNoticeUnsavedChanges();" type="checkbox" name="chkEditTrailQuickFactsTrailUse[]" value="' . $use . '"';											if (in_array($use, $cta->arTrailUse)) 				$output .= ' checked';			$output .= '><img src="' .$wgServer . '/images/icons/trailuse_' . strtolower($use) . '.png" width=20 						 title="' . $cta->getTrailUseAltText($use) . '" alt="' . $cta->getTrailUseAltText($use) . '">'; 			$nItems++;			if ($nItems % 5 == 0)				$output .= '<br>';			else 				$output .= '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';		}		$output .= '</td></tr>';					//elevation gain		$output .= '<tr><th>Elevation Gain ' . $quickfactsLink . ': </th>			<td><input type="text" style="width: 107px" onchange="changeNoticeUnsavedChanges();"			id="txtEditTrailQuickFactsElevationGain" name="txtEditTrailQuickFactsElevationGain" 			value="' . $cta->dElevationGainValue . '"> ';		$output .= '<select id="selEditTrailQuickFactsElevationGain" name="selEditTrailQuickFactsElevationGain" onchange="changeNoticeUnsavedChanges();">';		$output .= CleverTrailArticle::drawUnitsOptions('feet', $cta->sElevationGainUnits);		$output .= '</select>';		$output .= '</td></tr>';				//high point		$output .= '<tr><th>High Point ' . $quickfactsLink . ': </th>			<td><input type="text" style="width: 107px" onchange="changeNoticeUnsavedChanges();"			id="txtEditTrailQuickFactsHighPoint" name="txtEditTrailQuickFactsHighPoint" 			value="' . $cta->dHighPointValue . '"> ';		$output .= '<select id="selEditTrailQuickFactsHighPoint" name="selEditTrailQuickFactsHighPoint" onchange="changeNoticeUnsavedChanges();">';		$output .= CleverTrailArticle::drawUnitsOptions('feet', $cta->sHighPointUnits);		$output .= '</select>';		$output .= '</td></tr>';				//low point		$output .= '<tr><th>Low Point ' . $quickfactsLink . ': </th>			<td><input type="text" style="width: 107px" onchange="changeNoticeUnsavedChanges();"			id="txtEditTrailQuickFactsLowPoint" name="txtEditTrailQuickFactsLowPoint" 			value="' . $cta->dLowPointValue . '"> ';		$output .= '<select id="selEditTrailQuickFactsLowPoint" name="selEditTrailQuickFactsLowPoint" onchange="changeNoticeUnsavedChanges();">';		$output .= CleverTrailArticle::drawUnitsOptions('feet', $cta->sLowPointUnits);		$output .= '</select>';		$output .= '</td></tr>';				//best months		$output .= '<tr><th>Best Months ' . $quickfactsLink . ': </td><td>';		$nBestMonthBegin = $cta->nBestMonthBegin;		$nBestMonthEnd = $cta->nBestMonthEnd;		$bYearroundChecked = (($nBestMonthBegin == 1) && ($nBestMonthEnd == 12));		$output .= '<input onchange="changeNoticeUnsavedChanges();" type = "Radio" id="rbEditTrailQuickFactsBestMonthsMonths" name="rbEditTrailQuickFactsBestMonths" value= "months" ' . ($bYearroundChecked ? '' : 'checked') . '> ';		$output .= '<select onchange="changeNoticeUnsavedChanges();" ' . ($bYearroundChecked ? 'disabled="disabled"' : '') . ' 			class="input" id="selEditTrailQuickFactsBestMonthsBegin" name="selEditTrailQuickFactsBestMonthsBegin">';		$arMonths = CleverTrailArticle::getMonthsArray();		$nItems = 0;		foreach ($arMonths as $month) {							$output .= '<option value="' . $nItems . '" ';			if ($nBestMonthBegin == $nItems) 				$output .= ' selected';			$output .= '>' . $month . '</option>';			$nItems++;		}		$output .= '</select>';		$output .= ' to ';		$output .= '<select onchange="changeNoticeUnsavedChanges();" ' . ($bYearroundChecked ? 'disabled="disabled"' : '') . ' 			class="input" id="selEditTrailQuickFactsBestMonthsEnd" name="selEditTrailQuickFactsBestMonthsEnd">';		$arMonths = CleverTrailArticle::getMonthsArray();		$nItems = 0;		foreach ($arMonths as $month) {							$output .= '<option value="' . $nItems . '" ';			if ($nBestMonthEnd == $nItems) 				$output .= ' selected';			$output .= '>' . $month . '</option>';			$nItems++;		}		$output .= '</select><br>';		$output .= '<input onchange="changeNoticeUnsavedChanges();" type = "Radio" id="rbEditTrailQuickFactsBestMonthsYearround" name="rbEditTrailQuickFactsBestMonths" value= "yearround" ' . ($bYearroundChecked ? 'checked' : '') . '> ';		$output .= 'Year Round';		$output .= '</td></tr>';			//nearest city		$output .= '<tr><th>Nearest City ' . $quickfactsLink . ': </th>				<td><input type="text" id="txtEditTrailQuickFactsNearestCity" name="txtEditTrailQuickFactsNearestCity" style="width: 180px;"			 onchange="changeNoticeUnsavedChanges();" value="' . $cta->sNearestCity . '">';						$output .= '</td></tr>';				$output .= '</table>';		$output .= '</div>';		//DIV End: Quick Facts		$output .= '</div>';				//DIV Begin: Map		$mapLink = '<a style="text-decoration:underline;" href="../CleverTrail:Editing_Trails#Map" target="_blank">[?]</a>';				//map marker editor		$output .= '<div id="divEditTrailGoogleMapMarkerEditor">';		$output .= '<span id="spnEditTrailGoogleMapMarkerEditorTitle"></span> ' . $mapLink . ' :<br><br>';		$output .= 'Type of marker:<br>';		$output .= '<input type = "Radio" id="rbEditTrailGoogleMapMarkerTypeTrailhead" name="rbEditTrailGoogleMapMarkerType"  value= "Trailhead" checked> ';		$output .= '<img src="' . $wgServer . '/images/icons/googlemaps/Trailhead.png"> Trailhead ';		$output .= '<input type = "Radio" id="rbEditTrailGoogleMapMarkerTypePOI" name="rbEditTrailGoogleMapMarkerType"  value= "Poi"> ';				$output .= '<img src="' . $wgServer . '/images/icons/googlemaps/Poi.png"> Point Of Interest ';		$output .= '<input type = "Radio" id="rbEditTrailGoogleMapMarkerTypeTrailend" name="rbEditTrailGoogleMapMarkerType"  value= "Trailend"> ';				$output .= '<img src="' . $wgServer . '/images/icons/googlemaps/Trailend.png"> Trail End ';		$output .= '<br>Description:<br>';		$output .= '<textarea id="txtGoogleMapMarkerDescription"></textarea><br><br>';		$output .= '<input type="hidden" id="txtEditTrailGoogleMapMarkerLat">';		$output .= '<input type="hidden" id="txtEditTrailGoogleMapMarkerLong">';		$output .= '<table width=100%><tr><td align=left>';		$output .= '<input type="button" id="btnGoogleMapMarkerEditorSave" value="Save Marker"> ';		$output .= '<input type="button" id="btnGoogleMapMarkerEditorDelete" value="Delete Marker"> ';		$output .= '</td><td align=right ><input type="button" id="btnGoogleMapMarkerEditorCancel" value="Cancel"></td></tr></table>';		$output .= '</div>';				$output .= '<div class="clsEditTrailSectionContent" id="divEditTrailSectionMap" style=" display: ';		$output .= ($nSection == 9) ? 'block' : 'none';		$output .= '">';		$output .= '<div class="clsEditTrailContentHeader">					<b>Map ' . $mapLink . ' :</b> The map data is perhaps the most important data for a trail as they allow others to find it more easily					and also gives information on the trailhead, forks, and points of interest.</div>';		$output .= '<div id="divEditTrailGoogleMapContainer" style="text-align: left; height:400px">';						$output .= '<div id="divEditTrailGoogleMapSearch">';		$output .= '<table border=0 cellspacing=0 cellpadding=0 style="border: 0px;"><tr><td valign=top>';		$output .= '<input type="text" id="txtEditTrailGoogleMapSearch" name="txtEditTrailGoogleMapSearch" value="search for a map location or lat/long"					onkeypress="searchForAddressIfEnter(event);">';		$output .= '</td><td>';		$output .= '<input type="button" id="btnEditTrailGoogleMapSearch" name="btnEditTrailGoogleMapSearch" onclick="searchForAddress()">';					$output .= '</td></tr></table>';		$output .= '</div>';				$output .= '<div id="divEditTrailGoogleMap"></div>';				$output .= '</div>';				$output .= '<br>';				$output .= '<input type="hidden" id="txtEditTrailGoogleMapZoom" name="txtEditTrailGoogleMapZoom" value="' . $cta->nGoogleMapZoom . '">';		$output .= '<input type="hidden" id="txtEditTrailGoogleMapType" name="txtEditTrailGoogleMapType" value="' . $cta->sGoogleMapType . '">';		$output .= '<input type="hidden" id="txtEditTrailGoogleMapCenterLat" name="txtEditTrailGoogleMapCenterLat" value="' . $cta->dGoogleMapCenterLat . '">';		$output .= '<input type="hidden" id="txtEditTrailGoogleMapCenterLong" name="txtEditTrailGoogleMapCenterLong" value="' . $cta->dGoogleMapCenterLong . '">';				//display the google map if this section has been explicitly called		if ($nSection == 9)			$output .= '<script type="text/javascript"> window.onload = new function() {initGoogleMap();};</script>';				//create the markers		$output .= '<script type="text/javascript"> window.onload = new function() {';		for ($i=0; $i<sizeof($cta->arGoogleMapMarkerLats) && $i<sizeof($cta->arGoogleMapMarkerLongs); $i++) {			$output .= 'var gmMarker = createGMMarker(' . $cta->arGoogleMapMarkerLats[$i] . 						', ' . $cta->arGoogleMapMarkerLongs[$i] . 												', "' . $cta->arGoogleMapMarkerDescriptions[$i] . '"' .						', "' . $cta->arGoogleMapMarkerIcons[$i] . '");';			$output .= 'var ctMarker = new CTMarker(gmMarker' . 						', "' . $cta->arGoogleMapMarkerTypes[$i] . '"' . 						', "' . $cta->arGoogleMapMarkerDescriptions[$i] . '");';			$output .= 'myMarkers.push(ctMarker);';		}		$output .= '};</script>';				$output .= '</div>';				//DIV End: Map				//overview					$output .= '<div class="clsEditTrailSectionContent" id="divEditTrailSectionOverview" style="display: ';		$output .= ($nSection == 1) ? 'block' : 'none';		$output .= '">';		$output .= '<div class="clsEditTrailContentHeader">					<b>Overview:</b> Include a general description of the trail, what points of interest might be found on it,					and what might be seen along the way.</div><br>';		$output .= '<textarea class="clsEditTrailSectionInput" onkeypress="changeNoticeUnsavedChanges();" onchange="changeNoticeUnsavedChanges();"					 id="txtEditTrailOverview" name="txtEditTrailOverview">' . $cta->sOverview . '</textarea><br>';		$output .= '</div>';				//directions				$output .= '<div class="clsEditTrailSectionContent" id="divEditTrailSectionDirections" style="display: ';		$output .= ($nSection == 2) ? 'block' : 'none';		$output .= '">';		$output .= '<div class="clsEditTrailContentHeader">					<b>Directions To Trailhead:</b> Include directions to the trailhead from the nearest city or parking including walking, bicycling, or whichever					is most appropriate.</div><br>';		$output .= '<textarea class="clsEditTrailSectionInput" onkeypress="changeNoticeUnsavedChanges();" onchange="changeNoticeUnsavedChanges();"					id="txtEditTrailDirections" name="txtEditTrailDirections">' . $cta->sDirections . '</textarea><br>';		$output .= '</div>';				//description				$output .= '<div class="clsEditTrailSectionContent" id="divEditTrailSectionDescription" style="display: ';		$output .= ($nSection == 3) ? 'block' : 'none';		$output .= '">';		$output .= '<div class="clsEditTrailContentHeader">					<b>Trail Description</b>: A detailed description of the trail. Try to describe directions within the trail such as forks in					the trail or cairns. Include points of interest, overlooks, unique plants and animals, etc.</div><br>';		$output .= '<textarea class="clsEditTrailSectionInput" onkeypress="changeNoticeUnsavedChanges();" onchange="changeNoticeUnsavedChanges();"					id="txtEditTrailDescription" name="txtEditTrailDescription">' . $cta->sDescription . '</textarea><br>';		$output .= '</div>';				//conditions		$output .= '<div class="clsEditTrailSectionContent" id="divEditTrailSectionConditions" style="display: ';		$output .= ($nSection == 4) ? 'block' : 'none';		$output .= '">';		$output .= '<div class="clsEditTrailContentHeader">					<b>Conditions & Hazards</b>: Describe possible trail hazards and current or potential conditions. Hazards might include narrow					trails, poisonous animals or plants, etc. Conditions might include muddy trails after rain or snow closures and crowds.</div><br>';		$output .= '<textarea class="clsEditTrailSectionInput" onkeypress="changeNoticeUnsavedChanges();" onchange="changeNoticeUnsavedChanges();"					id="txtEditTrailConditions" name="txtEditTrailConditions">' . $cta->sConditions . '</textarea><br>';		$output .= '</div>';				//fees				$output .= '<div class="clsEditTrailSectionContent" id="divEditTrailSectionFees" style="display: ';		$output .= ($nSection == 5) ? 'block' : 'none';		$output .= '">';		$output .= '<div class="clsEditTrailContentHeader">					<b>Fees, Permits, & Restrictions</b>: Detail entrance or parking fees, any permits required for the trail (backpacking or 					climbing, for example), and restrictions on usage.</div><br>';		$output .= '<textarea class="clsEditTrailSectionInput" onkeypress="changeNoticeUnsavedChanges(); return true;" onchange="changeNoticeUnsavedChanges();"					id="txtEditTrailFees" name="txtEditTrailFees">' . $cta->sFees . '</textarea><br>';		$output .= '</div>';				//Amenities				$output .= '<div class="clsEditTrailSectionContent" id="divEditTrailSectionAmenities" style="display: ';		$output .= ($nSection == 6) ? 'block' : 'none';		$output .= '">';		$output .= '<div class="clsEditTrailContentHeader">					<b>Amenities</b>: Describe parking lots, drinking fountains, bathrooms, etc. 					Discuss what to do and where to go after the hike, for example good food joints or nearby watering holes.</div><br>';		$output .= '<textarea class="clsEditTrailSectionInput" onkeypress="changeNoticeUnsavedChanges();" onchange="changeNoticeUnsavedChanges();"					id="txtEditTrailAmenities" name="txtEditTrailAmenities">' . $cta->sAmenities . '</textarea><br>';		$output .= '</div>';				//misc				$output .= '<div class="clsEditTrailSectionContent" id="divEditTrailSectionMisc" style="display: ';		$output .= ($nSection == 7) ? 'block' : 'none';		$output .= '">';		$output .= '<div class="clsEditTrailContentHeader">					<b>Miscellaneous</b>: Any extra important facts or interesting trivia about the trail, 					crowd information, nearby points of interest, etc.</div><br>';		$output .= '<textarea class="clsEditTrailSectionInput" onkeypress="changeNoticeUnsavedChanges();" onchange="changeNoticeUnsavedChanges();"					id="txtEditTrailMisc" name="txtEditTrailMisc">' . $cta->sMisc . '</textarea><br>';		$output .= '</div>';		//photo gallery				$output .= '<div class="clsEditTrailSectionContent" id="divEditTrailSectionPhotoGallery" style="display: ';		$output .= ($nSection == 8) ? 'block' : 'none';		$output .= '">';		$output .= '<table border=0 style="font-size:90%"><tr><td colspan=2>';		$output .= 'Add Photo:<br>';		$output .= '<table border=0 cellspacing=0 cellpadding=0><tr><td valign=top>';				$output .= '<input type="text" name="txtEditTrailSectionPhotoGalleryAddImage" id = "txtEditTrailSectionPhotoGalleryAddImage" 					onkeypress="addImageToPhotoGalleryIfEnter(event);" >';		$output .= '</td><td>';		$output .= '<input type="button" name="btnEditTrailSectionPhotoGalleryAddImage" id="btnEditTrailSectionPhotoGalleryAddImage" 					value="" title="Add Photo"					onclick="addImageToPhotoGalleryListbox(document.getElementById(\'txtEditTrailSectionPhotoGalleryAddImage\', true).value); this.value=\'\';" >';		$output .= '</td></tr></table>';		$output .= '<center>(Don\'t forget to <a style="text-decoration:underline;" href="' . $uploadFilesLink . '" target="_blank">upload the image</a> first)</center>';		$output .= '</td></tr><tr><td>';		$output .= '<br>Image List:<br>';		$output .= '<select style="width: 200px" name="selEditTrailSectionPhotoGalleryImageList" id="selEditTrailSectionPhotoGalleryImageList" 					size="10">';		foreach ($cta->arPhotos as $photo) {							$output .= '<option value="' . $photo . '" ';			$output .= '>' . $photo . '</option>';		}		$output .= '</select>';		$output .= '</td><td valign=middle><br>';		$output .= '<input type="button" id="btnEditTrailSectionPhotoGalleryUp" title="Move Up"					class="clsEditTrailListBoxButton"					onclick="moveImageInPhotoGalleryListbox(true)"><br><br>';		$output .= '<input type="button" id="btnEditTrailSectionPhotoGalleryDelete" title="Delete"					class="clsEditTrailListBoxButton"					onclick="removeImageFromPhotoGalleryListbox()"><br><br>';		$output .= '<input type="button" id="btnEditTrailSectionPhotoGalleryDown" title="Move Down"					class="clsEditTrailListBoxButton"					onclick="moveImageInPhotoGalleryListbox(false)">';		$output .= '</td></tr></table>';				//the spans that will hold the actual images		for ($i = 1; $i <= 10; $i++){			$output .= '<span class="clsEditTrailPhotoGalleryImage" id="spnEditTrailPhotoGalleryImage' . $i . '">';							$output .= '</span>&nbsp;&nbsp;&nbsp;';		}				//hidden textboxes to hold the names of the images		for ($i = 1; $i <= 10; $i++){			$output .= '<input type="text" name="txtEditTrailSectionPhotoGalleryImageList' . $i . '" id="txtEditTrailSectionPhotoGalleryImageList' . $i . '" 						style="display:none;">';		}				$output .= '</div>';				//these lines must go after everything has been initialized for the photo gallery		foreach ($cta->arPhotos as $photo) {							$output .= '<script type="text/javascript"> window.onload = new function() {addImageToPhotoGalleryListbox(\'' . $photo . '\', false);}; </script>';		}		$output .= '<script type="text/javascript"> window.onload = new function() {createPhotoListAndGallery();}; </script>';				//categories		$output .= '<div class="clsEditTrailSectionContent" id="divEditTrailSectionCategories" style="display: ';		$output .= ($nSection == -3) ? 'block' : 'none';		$output .= '">';			$output .= '<table border=0 style="font-size:90%"><tr><td colspan=2>';		$output .= 'Add Category:<br>';		$output .= '<table border=0 cellspacing=0 cellpadding=0><tr><td valign=top>';		$output .= '<input type="text" name="txtEditTrailSectionCategoriesAdd" id = "txtEditTrailSectionCategoriesAdd"					onkeypress="addToCategoryIfEnter(event);" >';		$output .= '</td><td>';		$output .= '<input type="button" name="btnEditTrailSectionCategoriesAdd" id="btnEditTrailSectionCategoriesAdd" 					value="" title="Add Category"					onclick="addToCategoriesListbox(document.getElementById(\'txtEditTrailSectionCategoriesAdd\', true).value); this.value=\'\';" >';		$output .= '</td></tr></table>';		$output .= '</td></tr><tr><td>';		$output .= '<br>Category List:<br>';		$output .= '<select style="width: 200px" name="selEditTrailSectionCategoriesList" id="selEditTrailSectionCategoriesList" size="10">';		foreach ($cta->arCategories as $category) {							$output .= '<option value="' . $category . '" ';			$output .= '>' . $category . '</option>';		}		$output .= '</select>';		$output .= '</td><td valign=middle><br>';		$output .= '<input type="button" id="btnEditTrailSectionCategoriesUp" title="Move Up"					class="clsEditTrailListBoxButton"					onclick="moveCategoryInListbox(true)"><br><br>';		$output .= '<input type="button" id="btnEditTrailSectionCategoriesDelete" title="Delete"					class="clsEditTrailListBoxButton"					onclick="removeFromCategoriesListbox()"><br><br>';		$output .= '<input type="button" id="btnEditTrailSectionCategoriesDown" title="Move Down"					class="clsEditTrailListBoxButton"					onclick="moveCategoryInListbox(false)">';		$output .= '</td></tr></table>';				//hidden textboxes to  hold the names of the categories		for ($i = 1; $i <= 10; $i++){			$output .= '<input type="text" name="txtEditTrailSectionCategoriesList' . $i . '" id="txtEditTrailSectionCategoriesList' . $i . '" 						style="display:none;">';		}				$output .= '</div>';				//this line must go after everything has been initialized for the categories		foreach ($cta->arCategories as $category) {							$output .= '<script type="text/javascript"> window.onload = new function() {addToCategoriesListbox(\'' . $category . '\', false);}; </script>';		}				//END CONTENT		$output .= '</td>';				//BEGIN HELPFUL TIPS		$output .= '<td valign=top align=right>';		$output .= '<br><div id="divHelpfulTips">';		$output .= '<br><center><b style="font-size: 18pt">Helpful Tips <img src="' . $wgServer . '/images/icons/tips_24.png" width=24></b></center><BR>';				//helpful tips: quick facts		$output .= '<div class="clsEditTrailHelpfulTips" id="divEditTrailHelpfulTipsQuickFacts" style="display: ';		$output .= ($nSection == -1) ? 'block' : 'none';		$output .= '">';		$output .= '<ul>		<li><b><u>Important</u></b>: You must <a style="text-decoration:underline;" href="' . $uploadFilesLink . '" target="_blank">upload photos</a>		you want to use for this trail (e.g. for the Main Photo or the Photo Gallery) before trying to reference them. After uploading them, type the 		exact name of the file you want to make the Main Image, like "My_Trail1.jpg"<BR><BR>		<li>For measurements choose the units for the relevant region (for example a US trail uses feet, but a European trail uses meters).<BR><BR>		<li>Please see the <a style="text-decoration:underline;" href="../CleverTrail:Editing_Trails#Quick_Facts" target="_blank">Quick Facts help section</a>		for more info (opens in new tab).<BR><BR>		</ul></div>';				//helpful tips: map		$output .= '<div class="clsEditTrailHelpfulTips" id="divEditTrailHelpfulTipsMap" style="display: ';		$output .= ($nSection == 9) ? 'block' : 'none';		$output .= '">';		$linkToTrailhead1 = $wgServer . "/images/icons/googlemaps/Trailhead1.png";		$output .= '<ul>					<li>Click the Google Map to place markers and add descriptions for trailheads, points of interest, and trail ends. <BR><BR>		<li><b><u>Important</u></b>: Adding at least 1 trailhead is required when creating a new trail and all trailheads will show up		on the Map Of Trails (the homepage).<br><br>		<li>Clever Trail will save not only the markers but also the zoom factor, centering of the map, and type (Roadmap, Terrain, or Satellite) 		so keep that in mind while adjusting these attributes.<BR><BR>		</ul></div>';				//helpful tips: text input		$output .= '<div class="clsEditTrailHelpfulTips" id="divEditTrailHelpfulTipsTextInput" style="display: ';		$output .= ($nSection == 1 || $nSection == 2 || $nSection == 3 || $nSection == 4 || $nSection == 5 || $nSection == 6 || $nSection == 7)					? 'block' : 'none';		$output .= '">';		$output .= '<ul>		<li><b><u>Important</u></b>: You must <a style="text-decoration:underline;" href="' . $uploadFilesLink . '" target="_blank">upload images</a> 		you want to use for this trail before trying to reference them. You can then include the photo by typing: 		[[Photo:photo_name.jpg|optional caption]]<BR><BR>		<li>You can link to other trails by typing "[[Other Trail]]" and link to categories, such as national parks, by typing:		[[Category:Yosemite National Park]]<br><br>		<li>Additional ways to format the text can be found at 		<a style="text-decoration:underline;" href="../CleverTrail:Editing_Trails#Special_Formatting_Syntax" target="_blank">		Special Formatting Syntax help section</a>.		<BR><BR>		</ul></div>';						//helpful tips: photo gallery		$output .= '<div class="clsEditTrailHelpfulTips" id="divEditTrailHelpfulTipsPhotoGallery" style="display: ';		$output .= ($nSection == 8) ? 'block' : 'none';		$output .= '">';		$output .= '<ul>		<li><b><u>Important</u></b>: You must <a style="text-decoration:underline;" href="' . $uploadFilesLink . '" target="_blank">upload images</a> 		you want to use for this trail before trying to add them here. After uploading them, type the 		exact name of the file you want to make the Main Image, like "My_Trail1.jpg"<BR><BR>		<li>There can be up to 10 images for a trail in the Photo Gallery; try to pick images that give a good feel for the trail and highlight		any special sights or attributes.<BR><BR>		<li>There is no limit to the number of photos you can embed in various sections (Overview, Directions, etc).<BR><BR>		</ul></div>';				//helpful tips: categories		$output .= '<div class="clsEditTrailHelpfulTips" id="divEditTrailHelpfulTipsCategories" style="display: ';		$output .= ($nSection == -3) ? 'block' : 'none';		$output .= '">';		$output .= '<ul>		<li>Examples of categories include national or state parks (e.g. "Zion National Park"), types of climate or other general specifications (e.g. "Cloudforests"), 		and anything else that describes a special aspect of the trail (e.g. "Aurora Borealis", "Hummingbirds", etc).<BR><BR>		<li><b><u>Important</u></b>: Please add the state (or country if outside of the United States) as a category, as well as the city if the		trail is partly or entirely in the city.<BR><BR>		<li>Categories should <b>NOT</b> be subjective descriptions like "Spectacular View" or "Beautiful Valley".<br><br>		</ul></div>';				$output .= '</div></td>';				//END NAV TABLE		$output .= '</tr></table>';				$output .= '<br>Please note that all contributions to CleverTrail are considered to be released under the ' . $wgRightsText;		$output .= ' (see <a href="' . $wgScript . '/CleverTrail:Copyrights">CleverTrail:Copyrights</a> for details). You are also promising us that you 			wrote this yourself, or copied it from a public domain or similar free resource. <br><b>Do not submit copyrighted work without permission!</b>';				//End div for trail article types		$output .= '</div>';				//redirect page type		$output .= '<div id="divEditTrailRedirect" style="display: ';		if ($cta->sArticleType == "Redirect")			$output .= "block";		else			$output .= "none";		$output .= '">';				$output .= '<table cellpadding=0 cellspacing=0 border=0 width=100%>';		$output .= '<tr><td>';		$output .= '<center>Redirect this trail article to the following trail article name: <br><br>';		$output .= '<input type="text" name="txtEditTrailRedirect" value="' . $cta->sRedirect . '" style="width:200px">';		$output .= '</center><br><br>';		$output .= '</td>';				//helpful tips: redirect		$output .= '<td style="padding:1px" valign=middle align=right width=230>';		$output .= '<br><br><div class="clsEditTrailHelpfulTips" id="divEditTrailHelpfulTipsRedirect">';		$output .= '<br><center><b style="font-size: 18pt">Helpful Tips <img src="' . $wgServer . '/images/icons/tips_24.png" width=24></b></center><BR>';		$output .= '<ul>		<li>A redirect page is useful when there are multiple names referring to the same trail, 			for example "The John Muir Trail" and "John Muir Trail".<BR><BR>		<li>Please see the <a style="text-decoration:underline;" href="../CleverTrail:Editing_Trails#Redirect_Pages" target="_blank">Redirect Pages help section</a> 			for more info (opens in new tab).<BR><BR>					</ul></div>';				$output .= '</td></tr></table>';						$output .= '</div>';				//bottom submit buttons		$output .= '<br><input onclick="submitEditTrailForm(\'SaveGoTo\');" type="button" class="clsSubmitButton"			value="Save & Go To Trail" id="btnEditTrailSaveGoToTrail" name="btnEditTrailSaveGoToTrail" title="Save your changes and go to the trail"> ';		$output .= '<input onclick="submitEditTrailForm(\'SaveContinue\');" type="button"  class="clsSubmitButton"			value="Save & Continue Editing" id="btnEditTrailSaveContinue" name="btnEditTrailSaveContinue" title="Save your changes and continue editing"> ';		$output .= '<input onclick="submitEditTrailForm(\'Cancel\');" type="button"  class="clsSubmitButton"			value="Cancel" id="btnEditTrailCancel" name="btnEditTrailCancel" title="Cancel your changes and return to the trail"> ';													$output .= '</form>';										$wgOut->addHTML($output);	}		//returns a CleverTrailArticle for a trail from the posted data	function createCleverTrailArticleFromPost()	{		global $wgRequest;				$cta = new CleverTrailArticle();				//is this a redirect page type?		if ($wgRequest->getVal("selEditTrailArticleType") == "Redirect") {			$cta->sArticleType = "Redirect";			$cta->sRedirect = $wgRequest->getVal("txtEditTrailRedirect");			return $cta;		}				//otherwise it is a trail page type		$cta->sArticleType = "Trail";				$data = $wgRequest->getCheck("chkEditTrailAddDisambiguation");		$cta->bDisambiguationNote = $data;		$data = $wgRequest->getVal("txtDisambiguationBase");		$cta->sDisambiguationBase = $data;				//ImageName		$data = $wgRequest->getVal("txtEditTrailQuickFactsImage"); 		$cta->sImage = htmlspecialchars(trim($data));		$data = $wgRequest->getVal("txtEditTrailQuickFactsImageValid");		$cta->bImageValid = ($data != "0");				//Image Credit		$data = $wgRequest->getVal("imgEditTrailQuickFactsImageCredit");		$cta->sImageCredit = htmlspecialchars(trim($data));				//DifficultyRating		$data = $wgRequest->getVal("selEditTrailQuickFactsDifficulty"); 		$arDifficulty = CleverTrailArticle::getTrailDifficultyArray();		$cta->nDifficulty = $data;				//Distance		$data = $wgRequest->getVal("txtEditTrailQuickFactsDistance"); 		$cta->dDistanceValue = htmlspecialchars(trim($data));		$data = $wgRequest->getVal("selEditTrailQuickFactsDistance"); 		$cta->sDistanceUnits = $data;				//Time Required		$data = $wgRequest->getVal("txtEditTrailQuickFactsTimeRequiredMin"); 		$cta->dTimeRequiredMinValue = htmlspecialchars(trim($data));		$data = $wgRequest->getVal("txtEditTrailQuickFactsTimeRequiredMax"); 		$cta->dTimeRequiredMaxValue = htmlspecialchars(trim($data));		$data = $wgRequest->getVal("selEditTrailQuickFactsTimeRequired"); 		$cta->sTimeRequiredUnits = $data;				//TrailType		$data = $wgRequest->getVal("selEditTrailQuickFactsTrailType"); 		$cta->nTrailType = $data;						//ElevationGain		$data = $wgRequest->getVal("txtEditTrailQuickFactsElevationGain"); 		$cta->dElevationGainValue = htmlspecialchars(trim($data));		$data = $wgRequest->getVal("selEditTrailQuickFactsElevationGain"); 		$cta->sElevationGainUnits = $data;				//HighPoint		$data = $wgRequest->getVal("txtEditTrailQuickFactsHighPoint"); 		$cta->dHighPointValue = htmlspecialchars(trim($data));		$data = $wgRequest->getVal("selEditTrailQuickFactsHighPoint"); 		$cta->sHighPointUnits = $data;				//LowPoint		$data = $wgRequest->getVal("txtEditTrailQuickFactsLowPoint"); 		$cta->dLowPointValue = htmlspecialchars(trim($data));		$data = $wgRequest->getVal("selEditTrailQuickFactsLowPoint"); 		$cta->sLowPointUnits = $data;				//BestMonths		$data = $wgRequest->getVal("rbEditTrailQuickFactsBestMonths"); 		if ($data == "yearround")		{			$cta->nBestMonthBegin = 1;			$cta->nBestMonthEnd = 12;		}		else		{			$month = $wgRequest->getVal("selEditTrailQuickFactsBestMonthsBegin");			$cta->nBestMonthBegin = $month;			$month = $wgRequest->getVal("selEditTrailQuickFactsBestMonthsEnd");			$cta->nBestMonthEnd = $month;		}			//GoogleMap		$cta->nGoogleMapZoom = $wgRequest->getVal("txtEditTrailGoogleMapZoom"); 		$cta->sGoogleMapType = $wgRequest->getVal("txtEditTrailGoogleMapType"); 		$cta->dGoogleMapCenterLat = $wgRequest->getVal("txtEditTrailGoogleMapCenterLat"); 		$cta->dGoogleMapCenterLong = $wgRequest->getVal("txtEditTrailGoogleMapCenterLong"); 				$cta->arGoogleMapMarkerLats = $wgRequest->getArray("txtEditTrailGoogleMapMarkerLats"); 		$cta->arGoogleMapMarkerLongs = $wgRequest->getArray("txtEditTrailGoogleMapMarkerLongs");		$cta->arGoogleMapMarkerIcons = $wgRequest->getArray("txtEditTrailGoogleMapMarkerIcons"); 		$cta->arGoogleMapMarkerTypes = $wgRequest->getArray("txtEditTrailGoogleMapMarkerTypes"); 		$cta->arGoogleMapMarkerDescriptions = $wgRequest->getArray("txtEditTrailGoogleMapMarkerDescriptions"); 				//NearestCity		$data = $wgRequest->getVal("txtEditTrailQuickFactsNearestCity"); 		$cta->sNearestCity = htmlspecialchars(trim($data));					//TrailUse		$data = $wgRequest->getArray("chkEditTrailQuickFactsTrailUse"); 			if ($data)			$cta->arTrailUse = $data;				else			$cta->arTrailUse = array();				//Overview		$data = $wgRequest->getVal("txtEditTrailOverview"); 			$cta->sOverview = $this->convertClevertextToWikitext($data);			//Directions		$data = $wgRequest->getVal("txtEditTrailDirections"); 					$cta->sDirections = $this->convertClevertextToWikitext($data);							//Description		$data = $wgRequest->getVal("txtEditTrailDescription"); 					$cta->sDescription = $this->convertClevertextToWikitext($data);				//Conditions		$data = $wgRequest->getVal("txtEditTrailConditions"); 					$cta->sConditions = $this->convertClevertextToWikitext($data);				//Fees		$data = $wgRequest->getVal("txtEditTrailFees"); 					$cta->sFees = $this->convertClevertextToWikitext($data);				//After		$data = $wgRequest->getVal("txtEditTrailAmenities");		$cta->sAmenities = $this->convertClevertextToWikitext($data);				//Misc		$data = $wgRequest->getVal("txtEditTrailMisc"); 					$cta->sMisc = $this->convertClevertextToWikitext($data);				//Photo Gallery		for ($i = 1; $i <= 10; $i++){			if ($wgRequest->getVal("txtEditTrailSectionPhotoGalleryImageList$i") != "")				$cta->arPhotos[] = $wgRequest->getVal("txtEditTrailSectionPhotoGalleryImageList$i"); 			}				//Categories		for ($i = 1; $i <= 10; $i++){			if ($wgRequest->getVal("txtEditTrailSectionCategoriesList$i") != "")				$cta->arCategories[] = $wgRequest->getVal("txtEditTrailSectionCategoriesList$i"); 			}						return $cta;				}		//strip out anything that could potentially break the text	function convertClevertextToWikitext($data)	{		//make sure the user doesn't add a new main section ("==") or ("="), replace them with subsections ("===")		//add a carriage return (which will be stripped out later) for helping with the regex		$data = "\r" . $data . "\r";								//$1: a carriage return or linebreak		//$2: followed by 1 or 2 "="		//$3: followed by a non "=" and any number of other characters (i.e. the section name)		//$4: followed by 1 or 2 "="		//$5: followed by any amount of whitespace		//$6: followed by a return or linebreak		$data = preg_replace("/([\n|\r])([=]{2})([^=].*?)([=]{2})([\s]*?)([\n|\r])/", "$1===$3===$5$6", $data);				$data = preg_replace("/([\n|\r])([=]{1})([^=].*?)([=]{1})([\s]*?)([\n|\r])/", "$1===$3===$5$6", $data);					//special way to break being a line with just 3 or more "="		$data = preg_replace("/([\n|\r])([=]{3,})([\n|\r])/", "$1==$3", $data);					//replace our special tag "[[Photo:photo.jpg|caption]]" with the wiki syntax: [[File:image_name.jpg|thumb|left|caption]]				$data = preg_replace("/(\[\[Photo:)(.*?)(\|)(.*?)(\]\])/", "[[File:$2|thumb|left|$4]]", $data);			$data = preg_replace("/(\[\[Photo:)(.*?)(\]\])/", "[[File:$2|thumb|left]]", $data);					//replace our special tag [[Category:National Park]] with the wiki syntax: [[:Category:National Park|National Park]]		$data = preg_replace("/(\[\[Category:)(.*?)(\]\])/", "[[:Category:$2|$2]]", $data);					//remove any whitespace from the front of newlines				$data = preg_replace("/([\n|\r]+)([\s]+)(.+?)/", "$1$3", $data);								//strip out <!--xxx-->		$data = preg_replace("/\<!--(.*?)--\>/", "", $data);					//replace any attempts at html tags, strip whitespace off ends		$data = htmlspecialchars(trim($data));				return $data;	}		}?>